events {
    worker_connections 1024;
}

http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # --- UPSTREAMS ---
    upstream user_upstream {
        server user-service:3001;
    }

    upstream campaign_upstream {
        server campaign-service:3002;
    }

    upstream pledge_upstream {
        server pledge-service:3003;
    }
    
    # Assuming payment service code is similar to others
    upstream payment_upstream {
        server payment-service:3004;
    }

    upstream frontend_upstream {
        server frontend:3000;
    }

    server {
        listen 80;

        # --- FRONTEND ---
        location / {
            proxy_pass http://frontend_upstream;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
        }

        # --- USER SERVICE MAPPING ---
        # Frontend: POST /api/users/login
        # Backend:  POST /auth/login
        location /api/users {
            limit_req zone=api_limit burst=20 nodelay;
            
            # Rewrite /api/users/xyz -> /auth/xyz
            rewrite ^/api/users/(.*) /auth/$1 break;
            
            proxy_pass http://user_upstream;
            proxy_redirect off;
        }

        # --- CAMPAIGN SERVICE MAPPING ---
        # Frontend: GET /api/campaigns/list
        # Backend:  GET /campaigns/list
        location /api/campaigns {
            limit_req zone=api_limit burst=20 nodelay;
            
            # Rewrite /api/campaigns/xyz -> /campaigns/xyz
            rewrite ^/api/campaigns/(.*) /campaigns/$1 break;
            
            proxy_pass http://campaign_upstream;
            proxy_redirect off;
        }

        # --- PLEDGE SERVICE MAPPING ---
        # Frontend: POST /api/pledges/create
        # Backend:  POST /api/v1/create
        location /api/pledges {
            limit_req zone=api_limit burst=20 nodelay;
            
            # Rewrite /api/pledges/xyz -> /api/v1/xyz
            rewrite ^/api/pledges/(.*) /api/v1/$1 break;
            
            proxy_pass http://pledge_upstream;
            proxy_redirect off;
        }

        # --- PAYMENT SERVICE MAPPING ---
        location /api/payments {
            limit_req zone=api_limit burst=20 nodelay;
            # Assuming payment service uses root routes, adjust if it uses a prefix
            rewrite ^/api/payments/(.*) /$1 break; 
            proxy_pass http://payment_upstream;
        }
    }
}