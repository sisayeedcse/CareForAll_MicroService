events {
    worker_connections 1024;
}

http {
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # --- UPSTREAMS ---
    upstream user_upstream {
        server user-service:3001;
    }

    upstream campaign_upstream {
        server campaign-service:3002;
    }

    upstream pledge_upstream {
        server pledge-service:3003;
    }
    
    # Assuming payment service code is similar to others
    upstream payment_upstream {
        server payment-service:3004;
    }

    # --- FRONTEND UPSTREAMS ---
    upstream campaign_frontend {
        server campaign-frontend:80;
    }

    upstream user_frontend {
        server user-frontend:80;
    }

    upstream pledge_frontend {
        server pledge-frontend:80;
    }

    upstream payment_frontend {
        server payment-frontend:80;
    }

    server {
        listen 80;

        # --- GATEWAY ROOT ---
        location = / {
            default_type application/json;
            return 200 '{"message":"CareForAll API gateway"}';
        }

        # --- FRONTEND ROUTES (proxy to frontend containers) ---
        location /campaign/ {
            proxy_pass http://campaign_frontend/campaign/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /campaign {
            proxy_pass http://campaign_frontend/campaign;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /user/ {
            proxy_pass http://user_frontend/user/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /user {
            proxy_pass http://user_frontend/user;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /pledge/ {
            proxy_pass http://pledge_frontend/pledge/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /pledge {
            proxy_pass http://pledge_frontend/pledge;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /payment/ {
            proxy_pass http://payment_frontend/payment/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /payment {
            proxy_pass http://payment_frontend/payment;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /healthz {
            default_type application/json;
            return 200 '{"status":"ok"}';
        }

        # --- USER SERVICE MAPPING ---
        location /api/users/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://user_upstream/auth/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /api/users {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://user_upstream/auth;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- CAMPAIGN SERVICE MAPPING ---
        location /api/campaigns/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://campaign_upstream/campaigns/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /api/campaigns {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://campaign_upstream/campaigns;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- PLEDGE SERVICE MAPPING ---
        location /api/pledges/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://pledge_upstream/api/v1/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /api/pledges {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://pledge_upstream/api/v1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # --- PAYMENT SERVICE MAPPING ---
        location /api/payments/webhook {
            proxy_pass http://payment_upstream/payments/webhook;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /api/payments/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://payment_upstream/payments/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location = /api/payments {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://payment_upstream/payments;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}